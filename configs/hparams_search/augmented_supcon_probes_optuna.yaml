# @package _global_

# Hyperparameter optimization for Augmented SupCon embeddings using probe metrics as objective.
# Performs Optuna sweep on aug_supcon_6class experiment and optimizes embedding quality
# measured by linear probe accuracy.
#
# Example:
#   python src/train.py -m \
#     experiment=aug_supcon_6class \
#     hparams_search=augmented_supcon_probes_optuna \
#     paths=fm_testing_cineca data=collide2v_minicineca

defaults:
  - override /hydra/sweeper: optuna

# Optimization metric: defined in eval_probes.py and added to metric_dict in train.py
optimized_metric: "linear_probe_accuracy"

hydra:
  mode: "MULTIRUN"

  sweeper:
    _target_: hydra_plugins.hydra_optuna_sweeper.optuna_sweeper.OptunaSweeper

    # Where to save Optuna study (relative to paths.log_dir)
    storage: sqlite:///${paths.log_dir}/optuna_augmented_supcon_probes.db

    # Study name
    study_name: augmented_supcon_probes

    # Number of parallel jobs
    n_jobs: 1

    # Maximize probe metric
    direction: maximize

    # Total number of trials
    n_trials: 50

    sampler:
      _target_: optuna.samplers.TPESampler
      seed: 42
      n_startup_trials: 8
      multivariate: true

    # Hyperparameter search space (focused on augmented SupCon embeddings)
    params:
      # ============================================================
      # BACKBONE ARCHITECTURE
      # ============================================================
      model.d_model: choice(256, 512)
      model.num_layers: choice(2, 4, 6)
      model.d_ff: choice(256, 512, 1024)
      model.n_heads: choice(4, 8)
      model.dropout: tag(lin, interval(0.0, 0.2))

      # ============================================================
      # PROJECTION HEAD (for contrastive learning)
      # ============================================================
      model.projection_dim: choice(64, 128, 256)
      model.hidden_projection_dim: choice(128, 256, 512)

      # ============================================================
      # AUGMENTATION PARAMETERS (NEW for augmented SupCon)
      # ============================================================
      # Probability of masking features/particles
      model.mask_probability: tag(lin, interval(0.1, 0.5))
      
      # Whether to mask entire particles or individual features
      model.mask_full_particle: choice(true, false)
      
      # Number of augmented views per sample (typically 2)
      # model.num_augmentations: choice(2, 3)  # Usually keep at 2
      
      # ============================================================
      # CONTRASTIVE LOSS PARAMETERS
      # ============================================================
      model.temperature: tag(lin, interval(0.05, 0.15))
      
      # Note: base_temperature usually kept at 1.0 for simplicity
      # model.base_temperature: tag(lin, interval(0.07, 1.0))

      # ============================================================
      # CLASSIFICATION HEAD (for monitoring, optional)
      # ============================================================
      # Whether to use classification head for auxiliary supervision
      model.use_classification_head: choice(true, false)
      
      # Weight for classification loss if used
      model.classification_weight: tag(log, interval(0.05, 0.3))

      # ============================================================
      # OPTIMIZATION
      # ============================================================
      model.optimizer.lr: tag(log, interval(1e-4, 5e-4))
      model.optimizer.weight_decay: tag(log, interval(1e-6, 1e-2))

      # ============================================================
      # TRAINING CONFIGURATION
      # ============================================================
      # Batch size (important for contrastive learning)
      data.batch_size: choice(512, 1024, 2048)
