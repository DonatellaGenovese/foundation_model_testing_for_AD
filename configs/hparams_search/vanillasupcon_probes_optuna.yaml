# @package _global_

# Hyperparameter optimization for SupCon embeddings using probe metrics as objective.
# Esegue una sweep Optuna sull'esperimento vanillasupcon_6class_pretrain e
# ottimizza direttamente la qualit√† degli embedding misurata dal linear probe.
#
# Esempio di lancio:
#   python src/train.py -m \
#     experiment=vanillasupcon_6class_pretrain \
#     hparams_search=vanillasupcon_probes_optuna \
#     paths=fm_testing_cineca data=collide2v_minicineca

defaults:
  - override /hydra/sweeper: optuna

# Metrica di riferimento: definita in eval_probes.py e aggiunta a metric_dict in train.py
optimized_metric: "linear_probe_accuracy"

hydra:
  mode: "MULTIRUN"

  sweeper:
    _target_: hydra_plugins.hydra_optuna_sweeper.optuna_sweeper.OptunaSweeper

    # Dove salvare lo studio Optuna (relativo a paths.log_dir)
    storage: sqlite:///${paths.log_dir}/optuna_supcon_probes.db

    # Nome dello studio
    study_name: vanillasupcon_probes

    # Numero di job paralleli
    n_jobs: 1

    # Massimizza la metrica del probe
    direction: maximize

    # Numero totale di trial (abbastanza preciso ma non enorme)
    n_trials: 40

    sampler:
      _target_: optuna.samplers.TPESampler
      seed: 42
      n_startup_trials: 5
      multivariate: true

    # Spazio degli iperparametri (concentrato sugli embedding SupCon)
    params:
      # Geometria del backbone
      model.d_model: choice(256, 512)
      model.num_layers: choice(2, 4)
      model.d_ff: choice(512, 1024)
      model.n_heads: choice(4, 8)
      model.dropout: tag(lin, interval(0.0, 0.2))

      # Proiezione SupCon
      model.projection_dim: choice(64, 128)
      model.hidden_projection_dim: choice(128, 256)
      model.temperature: tag(lin, interval(0.05, 0.15))

      # Ottimizzatore
      model.optimizer.lr: tag(log, interval(1e-4, 5e-4))
      model.optimizer.weight_decay: tag(log, interval(1e-6, 1e-4))
